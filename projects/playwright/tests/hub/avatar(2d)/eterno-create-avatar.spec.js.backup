const { test, expect } = require('@playwright/test');
const config = require('../../../config/test-config');
const { loginAndHandleCookies } = require('../../../utils/auth-helper');

// ë¬´ì‘ìœ„ ì•„ë°”íƒ€ ì´ë¦„ ìƒì„± í•¨ìˆ˜
function generateRandomAvatarName() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return `TestAvatar_${result}`;
}

// ê²½ê³  íŒì—… ì²˜ë¦¬ í•¨ìˆ˜
async function handleWarningPopup(page) {
  try {
    // "Oops! An unknown error has occurred" íŒì—… í™•ì¸
    const reloadButton = page.locator('button:has-text("Reload")');
    if (await reloadButton.count() > 0) {
      console.log('âš ï¸ ê²½ê³  íŒì—… ë°œê²¬! Reload ë²„íŠ¼ í´ë¦­...');
      await reloadButton.click();
      await page.waitForTimeout(3000); // í˜ì´ì§€ ë¦¬ë¡œë“œ ëŒ€ê¸°
      console.log('âœ… í˜ì´ì§€ ë¦¬ë¡œë“œ ì™„ë£Œ!');
      
      // Skintight Mask ì¬ì„ íƒ
      console.log('ğŸ”„ Skintight Mask ì¬ì„ íƒ...');
      const skintightMaskElement = page.locator('div.TemplateItem_imageBox__xt_7I:has(img[alt="Skintight Mask"])');
      await expect(skintightMaskElement).toBeVisible({ timeout: 10000 });
      await skintightMaskElement.click();
      console.log('âœ… Skintight Mask ì¬ì„ íƒ ì™„ë£Œ!');
      
      // PNG íŒŒì¼ ë‹¤ì‹œ ì—…ë¡œë“œ
      console.log('ğŸ”„ PNG íŒŒì¼ ë‹¤ì‹œ ì—…ë¡œë“œ...');
      const uploadButton = page.locator('button[data-testid="file-input-btn"]');
      await expect(uploadButton).toBeVisible({ timeout: 10000 });
      console.log('ì—…ë¡œë“œ ë²„íŠ¼ ë°œê²¬!');
      
      // íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì´ë²¤íŠ¸ ëŒ€ê¸°
      const fileChooserPromise = page.waitForEvent('filechooser');
      
      // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­
      await uploadButton.click();
      console.log('ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
      
      // íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì²˜ë¦¬
      const fileChooser = await fileChooserPromise;
      await fileChooser.setFiles('C:\\Users\\cmiron\\Desktop\\imagemaker\\512x512.png');
      console.log('PNG íŒŒì¼ ì„ íƒ ì™„ë£Œ!');
      
      // ì—…ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
      await page.waitForTimeout(3000);
      console.log('PNG íŒŒì¼ ì¬ì—…ë¡œë“œ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!');
      
      return true; // íŒì—… ì²˜ë¦¬ë¨
    }
  } catch (error) {
    console.log('ê²½ê³  íŒì—…ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë¨');
  }
  return false; // íŒì—… ì—†ìŒ
}

test.describe('Eterno Studio Create Avatar Item ìë™í™”', () => {
  test('1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜', async ({ page }) => {
    test.setTimeout(60000); // 1ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('ğŸ” 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜ ì‹œì‘...');
    await loginAndHandleCookies(page);
    console.log('âœ… 1ë‹¨ê³„ ì™„ë£Œ: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('1ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
  
  test('2ë‹¨ê³„: Create í˜ì´ì§€ ì´ë™ ë° Avatar Item ì„ íƒ', async ({ page }) => {
    test.setTimeout(60000); // 1ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('ğŸ“ 2ë‹¨ê³„: Create í˜ì´ì§€ ì´ë™ ë° Avatar Item ì„ íƒ ì‹œì‘...');
    
    // 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜
    await loginAndHandleCookies(page);
    
    // 2ë‹¨ê³„: Create í˜ì´ì§€ë¡œ ì´ë™
    console.log('Create í˜ì´ì§€ë¡œ ì´ë™...');
    await page.goto('https://eterno-qa.ovdr.io/creator/create');
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(1000);
    
    // 3ë‹¨ê³„: Avatar Item ë²„íŠ¼ í´ë¦­
    console.log('Avatar Item ë²„íŠ¼ ì°¾ê¸° ë° í´ë¦­...');
    const avatarItemButton = page.locator('div:has-text("Avatar item"):not(:has-text("Super easy"))');
    await expect(avatarItemButton).toBeVisible();
    await avatarItemButton.click();
    
    // Avatar Item í´ë¦­ í›„ ì•ˆì •ì ì¸ ëŒ€ê¸°
    await page.waitForLoadState('networkidle');
    
    // URL ë³€ê²½ í™•ì¸
    const avatarItemUrl = page.url();
    console.log('Avatar Item í´ë¦­ í›„ URL:', avatarItemUrl);
    
    // í…œí”Œë¦¿ ì•„ì´í…œë“¤ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    try {
      await page.waitForSelector('div.TemplateItem_imageBox__xt_7I', { 
        timeout: 15000,
        state: 'visible'
      });
      console.log('í…œí”Œë¦¿ ì•„ì´í…œë“¤ì´ ë¡œë“œë¨!');
    } catch (error) {
      console.log('í…œí”Œë¦¿ ì•„ì´í…œ ë¡œë”© ì‹¤íŒ¨. ê³„ì† ì§„í–‰...');
    }
    
    console.log('âœ… 2ë‹¨ê³„ ì™„ë£Œ: Create í˜ì´ì§€ ì´ë™ ë° Avatar Item ì„ íƒ');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('2ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
  
  test('3ë‹¨ê³„: Skintight Mask í…œí”Œë¦¿ ì„ íƒ', async ({ page }) => {
    test.setTimeout(60000); // 1ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('ğŸ­ 3ë‹¨ê³„: Skintight Mask í…œí”Œë¦¿ ì„ íƒ ì‹œì‘...');
    
    // 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜
    await loginAndHandleCookies(page);
    
    // 2ë‹¨ê³„: Create í˜ì´ì§€ë¡œ ì´ë™
    await page.goto('https://eterno-qa.ovdr.io/creator/create');
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(1000);
    
    // 3ë‹¨ê³„: Avatar Item ë²„íŠ¼ í´ë¦­
    const avatarItemButton = page.locator('div:has-text("Avatar item"):not(:has-text("Super easy"))');
    await expect(avatarItemButton).toBeVisible();
    await avatarItemButton.click();
    await page.waitForLoadState('networkidle');
    
    // 4ë‹¨ê³„: Skintight Mask ì¹´í…Œê³ ë¦¬ ì°¾ê¸° ë° ì„ íƒ
    console.log('Skintight Mask ì¹´í…Œê³ ë¦¬ ì°¾ê¸°...');
    
    // í˜„ì¬ URL í™•ì¸
    const currentUrl = page.url();
    console.log('í˜„ì¬ URL:', currentUrl);
    
    // ì¿ í‚¤ ë™ì˜ íŒì—… ì²˜ë¦¬
    try {
      const cookieAcceptButton = page.locator('button:has-text("Accept All"), button.primary_QRLmx:has-text("Accept All")');
      if (await cookieAcceptButton.count() > 0) {
        console.log('ì¿ í‚¤ ë™ì˜ íŒì—… ë°œê²¬! Accept All ë²„íŠ¼ í´ë¦­...');
        await cookieAcceptButton.first().click();
        await page.waitForTimeout(1000);
      }
    } catch (error) {
      console.log('ì¿ í‚¤ ë™ì˜ íŒì—…ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë¨');
    }
    
    // Skintight Mask ìš”ì†Œ ì°¾ê¸°
    const skintightMaskElement = page.locator('div.TemplateItem_imageBox__xt_7I:has(img[alt="Skintight Mask"])');
    
    try {
      await expect(skintightMaskElement).toBeVisible({ timeout: 5000 });
      console.log('Skintight Mask ìš”ì†Œ ë°œê²¬!');
      
      // Skintight Mask í´ë¦­
      await skintightMaskElement.click();
      console.log('Skintight Mask ì„ íƒ ì™„ë£Œ!');
      
    } catch (error) {
      console.log('Skintight Mask ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì²´ ë°©ë²• ì‹œë„...');
      
      // ëŒ€ì²´ ë°©ë²•: alt ì†ì„±ìœ¼ë¡œ ì°¾ê¸°
      const skintightMaskImg = page.locator('img[alt="Skintight Mask"]');
      if (await skintightMaskImg.count() > 0) {
        await skintightMaskImg.first().click();
        console.log('Skintight Mask ì´ë¯¸ì§€ í´ë¦­ ì™„ë£Œ!');
      } else {
        throw new Error('Skintight Mask ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    }
    
    console.log('âœ… 3ë‹¨ê³„ ì™„ë£Œ: Skintight Mask í…œí”Œë¦¿ ì„ íƒ');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('3ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
  
  test('4ë‹¨ê³„: PNG íŒŒì¼ ì—…ë¡œë“œ', async ({ page }) => {
    test.setTimeout(120000); // 2ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('ğŸ“ 4ë‹¨ê³„: PNG íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...');
    
    // 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜
    await loginAndHandleCookies(page);
    
    // 2ë‹¨ê³„: Create í˜ì´ì§€ë¡œ ì´ë™
    await page.goto('https://eterno-qa.ovdr.io/creator/create');
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(1000);
    
    // 3ë‹¨ê³„: Avatar Item ë²„íŠ¼ í´ë¦­
    const avatarItemButton = page.locator('div:has-text("Avatar item"):not(:has-text("Super easy"))');
    await expect(avatarItemButton).toBeVisible();
    await avatarItemButton.click();
    await page.waitForLoadState('networkidle');
    
    // 4ë‹¨ê³„: Skintight Mask ì„ íƒ
    const skintightMaskElement = page.locator('div.TemplateItem_imageBox__xt_7I:has(img[alt="Skintight Mask"])');
    await expect(skintightMaskElement).toBeVisible({ timeout: 5000 });
    await skintightMaskElement.click();
    
    // 5ë‹¨ê³„: PNG íŒŒì¼ ì—…ë¡œë“œ
    console.log('PNG íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...');
    
    // ì—…ë¡œë“œ ë²„íŠ¼ ì°¾ê¸° (data-testid ì‚¬ìš©)
    const uploadButton = page.locator('button[data-testid="file-input-btn"]');
    await expect(uploadButton).toBeVisible({ timeout: 10000 });
    console.log('ì—…ë¡œë“œ ë²„íŠ¼ ë°œê²¬!');
    
    // íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì´ë²¤íŠ¸ ëŒ€ê¸°
    const fileChooserPromise = page.waitForEvent('filechooser');
    
    // ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­
    await uploadButton.click();
    console.log('ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
    
    // íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì²˜ë¦¬
    const fileChooser = await fileChooserPromise;
    await fileChooser.setFiles('C:\\Users\\cmiron\\Desktop\\imagemaker\\512x512.png');
    console.log('PNG íŒŒì¼ ì„ íƒ ì™„ë£Œ!');
    
    // ì—…ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
    await page.waitForTimeout(3000);
    console.log('PNG íŒŒì¼ ì—…ë¡œë“œ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!');
    
    // ê²½ê³  íŒì—… ì²˜ë¦¬
    await handleWarningPopup(page);
    
    console.log('âœ… 4ë‹¨ê³„ ì™„ë£Œ: PNG íŒŒì¼ ì—…ë¡œë“œ');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('4ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
  
  test('5ë‹¨ê³„: ì•„ì´í…œ ì •ë³´ ì…ë ¥', async ({ page }) => {
    test.setTimeout(120000); // 2ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('ğŸ“ 5ë‹¨ê³„: ì•„ì´í…œ ì •ë³´ ì…ë ¥ ì‹œì‘...');
    
    // ë¬´ì‘ìœ„ ì•„ë°”íƒ€ ì´ë¦„ ìƒì„±
    const randomAvatarName = generateRandomAvatarName();
    console.log(`ìƒì„±ëœ ì•„ë°”íƒ€ ì´ë¦„: ${randomAvatarName}`);
    
    // 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜
    await loginAndHandleCookies(page);
    
    // 2ë‹¨ê³„: Create í˜ì´ì§€ë¡œ ì´ë™
    await page.goto('https://eterno-qa.ovdr.io/creator/create');
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(1000);
    
    // 3ë‹¨ê³„: Avatar Item ë²„íŠ¼ í´ë¦­
    const avatarItemButton = page.locator('div:has-text("Avatar item"):not(:has-text("Super easy"))');
    await expect(avatarItemButton).toBeVisible();
    await avatarItemButton.click();
    await page.waitForLoadState('networkidle');
    
    // 4ë‹¨ê³„: Skintight Mask ì„ íƒ
    const skintightMaskElement = page.locator('div.TemplateItem_imageBox__xt_7I:has(img[alt="Skintight Mask"])');
    await expect(skintightMaskElement).toBeVisible({ timeout: 5000 });
    await skintightMaskElement.click();
    
    // 5ë‹¨ê³„: PNG íŒŒì¼ ì—…ë¡œë“œ
    const uploadButton = page.locator('button[data-testid="file-input-btn"]');
    await expect(uploadButton).toBeVisible({ timeout: 10000 });
    const fileChooserPromise = page.waitForEvent('filechooser');
    await uploadButton.click();
    const fileChooser = await fileChooserPromise;
    await fileChooser.setFiles('C:\\Users\\cmiron\\Desktop\\imagemaker\\512x512.png');
    await page.waitForTimeout(3000);
    
    // ê²½ê³  íŒì—… ì²˜ë¦¬
    await handleWarningPopup(page);
    
    // 6ë‹¨ê³„: Next ë²„íŠ¼ í´ë¦­
    console.log('Next ë²„íŠ¼ í´ë¦­...');
    const nextButton = page.locator('button:has-text("Next"), button[data-testid*="next"], button.primary_QRLmx:has-text("Next")');
    await expect(nextButton).toBeVisible({ timeout: 10000 });
    await nextButton.click();
    console.log('Next ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
    
    // í˜ì´ì§€ ì´ë™ ëŒ€ê¸° (ë” ì•ˆì •ì ì¸ ë°©ë²•)
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(3000);
    
    // URL ë³€ê²½ í™•ì¸
    const nextPageUrl = page.url();
    console.log('Next ë²„íŠ¼ í´ë¦­ í›„ URL:', nextPageUrl);
    
    // 7ë‹¨ê³„: ì•„ì´í…œ ì •ë³´ ì…ë ¥
    console.log('ì•„ì´í…œ ì •ë³´ ì…ë ¥...');
    
    // í˜ì´ì§€ ë¡œë”© ëŒ€ê¸° (ë” ë¹ ë¥¸ ë°©ë²•)
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(2000);
    
    // í˜„ì¬ URL í™•ì¸
    const infoPageUrl = page.url();
    console.log('í˜„ì¬ URL:', infoPageUrl);
    
    // í˜ì´ì§€ ë‚´ìš© í™•ì¸ (ë””ë²„ê¹…ìš©)
    const pageContent = await page.textContent('body');
    console.log('í˜ì´ì§€ ë‚´ìš© í™•ì¸:', pageContent.substring(0, 500) + '...');
    
    // Name í•„ë“œ ì°¾ê¸° ë° ì…ë ¥ (ì •í™•í•œ locator ì‚¬ìš©)
    const nameField = page.locator('input[placeholder="Enter name"]');
    await expect(nameField).toBeVisible({ timeout: 15000 });
    await nameField.fill(randomAvatarName);
    console.log(`Name í•„ë“œ ì…ë ¥ ì™„ë£Œ: ${randomAvatarName}`);
    
    // Price í•„ë“œ ì°¾ê¸° ë° ì…ë ¥ (ì •í™•í•œ locator ì‚¬ìš©)
    const priceField = page.locator('input[placeholder="Enter price"]');
    await expect(priceField).toBeVisible({ timeout: 15000 });
    await priceField.fill('500');
    console.log('Price í•„ë“œ ì…ë ¥ ì™„ë£Œ: 500');
    
    // ì…ë ¥ ì™„ë£Œ ëŒ€ê¸°
    await page.waitForTimeout(1000);
    console.log('ì•„ì´í…œ ì •ë³´ ì…ë ¥ ì™„ë£Œ!');
    
    console.log('âœ… 5ë‹¨ê³„ ì™„ë£Œ: ì•„ì´í…œ ì •ë³´ ì…ë ¥');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('5ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
  
  test('6ë‹¨ê³„: ë™ì˜ ì²´í¬ë°•ìŠ¤ ë° Complete', async ({ page }) => {
    test.setTimeout(120000); // 2ë¶„ íƒ€ì„ì•„ì›ƒ
    
    console.log('âœ… 6ë‹¨ê³„: ë™ì˜ ì²´í¬ë°•ìŠ¤ ë° Complete ì‹œì‘...');
    
    // ë¬´ì‘ìœ„ ì•„ë°”íƒ€ ì´ë¦„ ìƒì„±
    const randomAvatarName = generateRandomAvatarName();
    console.log(`ìƒì„±ëœ ì•„ë°”íƒ€ ì´ë¦„: ${randomAvatarName}`);
    
    // 1ë‹¨ê³„: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ë™ì˜
    await loginAndHandleCookies(page);
    
    // 2ë‹¨ê³„: Create í˜ì´ì§€ë¡œ ì´ë™
    await page.goto('https://eterno-qa.ovdr.io/creator/create');
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(1000);
    
    // 3ë‹¨ê³„: Avatar Item ë²„íŠ¼ í´ë¦­
    const avatarItemButton = page.locator('div:has-text("Avatar item"):not(:has-text("Super easy"))');
    await expect(avatarItemButton).toBeVisible();
    await avatarItemButton.click();
    await page.waitForLoadState('networkidle');
    
    // 4ë‹¨ê³„: Skintight Mask ì„ íƒ
    const skintightMaskElement = page.locator('div.TemplateItem_imageBox__xt_7I:has(img[alt="Skintight Mask"])');
    await expect(skintightMaskElement).toBeVisible({ timeout: 5000 });
    await skintightMaskElement.click();
    
    // 5ë‹¨ê³„: PNG íŒŒì¼ ì—…ë¡œë“œ
    const uploadButton = page.locator('button[data-testid="file-input-btn"]');
    await expect(uploadButton).toBeVisible({ timeout: 10000 });
    const fileChooserPromise = page.waitForEvent('filechooser');
    await uploadButton.click();
    const fileChooser = await fileChooserPromise;
    await fileChooser.setFiles('C:\\Users\\cmiron\\Desktop\\imagemaker\\512x512.png');
    await page.waitForTimeout(3000);
    
    // ê²½ê³  íŒì—… ì²˜ë¦¬
    await handleWarningPopup(page);
    
    // 6ë‹¨ê³„: Next ë²„íŠ¼ í´ë¦­
    const nextButton = page.locator('button:has-text("Next"), button[data-testid*="next"], button.primary_QRLmx:has-text("Next")');
    await expect(nextButton).toBeVisible({ timeout: 10000 });
    await nextButton.click();
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(3000);
    
    // 7ë‹¨ê³„: ì•„ì´í…œ ì •ë³´ ì…ë ¥
    const nameField = page.locator('input[placeholder="Enter name"]');
    await expect(nameField).toBeVisible({ timeout: 15000 });
    await nameField.fill(randomAvatarName);
    
    const priceField = page.locator('input[placeholder="Enter price"]');
    await expect(priceField).toBeVisible({ timeout: 15000 });
    await priceField.fill('500');
    await page.waitForTimeout(1000);
    
    // 8ë‹¨ê³„: Next ë²„íŠ¼ í´ë¦­ (ë™ì˜ í˜ì´ì§€ë¡œ ì´ë™)
    console.log('Next ë²„íŠ¼ í´ë¦­ (ë™ì˜ í˜ì´ì§€ë¡œ ì´ë™)...');
    const nextButton2 = page.locator('button:has-text("Next"), button[data-testid*="next"], button.primary_QRLmx:has-text("Next")');
    await expect(nextButton2).toBeVisible({ timeout: 10000 });
    await nextButton2.click();
    console.log('Next ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
    
    // í˜ì´ì§€ ì´ë™ ëŒ€ê¸°
    await page.waitForLoadState('domcontentloaded');
    await page.waitForTimeout(3000);
    
    // 9ë‹¨ê³„: ë™ì˜ ì²´í¬ë°•ìŠ¤ ì„ íƒ
    console.log('ë™ì˜ ì²´í¬ë°•ìŠ¤ ì„ íƒ...');
    const agreementCheckbox = page.locator('button[role="checkbox"][data-state="unchecked"]');
    await expect(agreementCheckbox).toBeVisible({ timeout: 10000 });
    await agreementCheckbox.click();
    console.log('ë™ì˜ ì²´í¬ë°•ìŠ¤ ì„ íƒ ì™„ë£Œ!');
    
    // 10ë‹¨ê³„: Complete ë²„íŠ¼ í´ë¦­
    console.log('Complete ë²„íŠ¼ í´ë¦­...');
    const completeButton = page.locator('button:has-text("Complete"), button[data-testid*="complete"], button.primary_QRLmx:has-text("Complete")');
    await expect(completeButton).toBeVisible({ timeout: 10000 });
    await completeButton.click();
    console.log('Complete ë²„íŠ¼ í´ë¦­ ì™„ë£Œ!');
    
    // ì™„ë£Œ ëŒ€ê¸°
    await page.waitForTimeout(3000);
    console.log('ì•„ë°”íƒ€ ì•„ì´í…œ ìƒì„± ì™„ë£Œ!');
    
    console.log('âœ… 6ë‹¨ê³„ ì™„ë£Œ: ë™ì˜ ì²´í¬ë°•ìŠ¤ ë° Complete');
    
    // ë¸Œë¼ìš°ì € ìœ ì§€ (ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ë³€ê²½)
    console.log('6ë‹¨ê³„ ì™„ë£Œ! ë¸Œë¼ìš°ì €ë¥¼ 3ì´ˆê°„ ìœ ì§€í•©ë‹ˆë‹¤...');
    try {
      await page.waitForTimeout(3000);
    } catch (error) {
      if (error.message.includes('Target page, context or browser has been closed')) {
        console.log('ë¸Œë¼ìš°ì €ê°€ ì´ë¯¸ ë‹«í˜”ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì™„ë£Œ.');
      } else {
        throw error;
      }
    }
  });
});